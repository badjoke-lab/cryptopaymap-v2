# JSON保険（places.json fallback）運用ルール

## 目的
DB障害などで本来のデータソースが0件になる事故を避け、最低限のデモ/回遊ができる状態を保つための「保険」として運用する。

## なぜ必要か
- DB障害や接続不良が起きたときに、0件表示で体験が止まるのを防ぐ。
- 最低限のデータがあることで、UIや導線の確認が継続できる。

## いつ更新するか
以下のいずれかを満たすタイミングで更新する。
- 大きなデータ更新（カテゴリ追加や構造変更）を行ったとき
- リリース前（動作確認の基準を合わせたいとき）
- 月1回の定期メンテナンス時

## いつ捨てるか
次の状態が揃ったら保険JSONの運用を廃止する。
- DB稼働が安定し、障害時の監視・アラートが整備されている
- 再試行・キャッシュ・フェイルオーバーなどの仕組みが実装済み
- DB停止時でも最低限の体験が保証される手段がある

## 古さの許容範囲
- 目的は「最低限のデモ/回遊」なので、多少古くても許容する。
- 正確性が必要な情報（例: 営業時間や最新イベント）はJSONで担保しない。

## 事故時の挙動確認方法
- `DATA_SOURCE=json` に切り替えてJSONが返ることを確認する
- `DATA_SOURCE=auto` でDBが落ちている状況を想定し、JSON fallback が動くことを確認する

## DATA_SOURCE=auto の挙動（明示）
- DB利用の前提：`DATABASE_URL` が設定されているときのみ DB を試行する。
- fallback 発生条件：
  - DB接続エラー（接続拒否・タイムアウト・一時的な接続断）
  - DBクエリ実行時の例外（スキーマ欠落やSQL失敗を含む）
  - DB結果が取得できない場合（null/undefined）
- fallback しない条件：
  - DBから取得できた結果が **空** である場合（空配列/0件はそのまま返す）
- ログとユーザー表示：
  - サーバー側ログに理由を記録
  - ユーザー向けには **Limited mode** の通知のみ表示（詳細なエラー文は出さない）

## 注意
- JSONは真実のデータではなく「保険」である。
- 仕様決定や最新情報の根拠にしない。
