# ğŸ“„ **ui-map-v3.2.md â€” Mapï¼ˆãƒãƒƒãƒ—ï¼‰å®Œå…¨ä»•æ§˜æ›¸ v3.2**

**Status:** Final / å®Ÿè£…å¯èƒ½ãƒ¬ãƒ™ãƒ«
**Scope:**
CryptoPayMap v2 ã® **Map UI å…¨ä»•æ§˜**
ï¼ˆPC / Mobileã€Leafletã€ãƒ”ãƒ³ã€ã‚¯ãƒ©ã‚¹ã‚¿ã€ãƒ•ã‚£ãƒ«ã‚¿é€£å‹•ã€Popup â†’ Draweré€£æºã¾ã§å…¨éƒ¨ï¼‰

â€» Drawer / Popup / Filters ã¨ã¯åˆ¥ç´™ã§åˆ†é›¢ã—ã¦ã„ã‚‹ãŒã€
**Map å´ã‹ã‚‰ã®é€£å‹•ä»•æ§˜ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£æœ¬**ã€‚

---

# 1. å…¨ä½“ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

CryptoPayMap ã® Map UI ã¯ä»¥ä¸‹ã‚’æº€ãŸã™ï¼š

* 3,000 ä»¶ä»¥ä¸Šã®åº—èˆ—ã§ã‚‚é«˜é€Ÿï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°å‰æï¼‰
* ãƒ”ãƒ³è‰²ã§èªè¨¼æ®µéšãŒä¸€ç›®ã§ã‚ã‹ã‚‹
* ãƒ›ãƒãƒ¼ â†’ Popup
  ã‚¯ãƒªãƒƒã‚¯ â†’ Drawerï¼ˆè©³ç´°ï¼‰
* PC / Mobile ã§æŒ™å‹•ãŒå¤‰ã‚ã‚‹
* ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´ã¯ã™ã¹ã¦ Map ã«åæ˜ ã•ã‚Œã‚‹ï¼ˆã‚¯ã‚¨ãƒªåŒæœŸï¼‰

---

# 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

* **Leaflet 1.9**
* React Leaflet å…¬å¼ã¯ä½¿ç”¨ã—ãªã„ï¼ˆapp router ã¨ã®ç›¸æ€§å•é¡Œå›é¿ï¼‰
* `L.map`, `L.marker`, `L.tileLayer`, `L.geoJSON`, `L.markerClusterGroup`
* ã‚¿ã‚¤ãƒ«ï¼šOpenStreetMapï¼ˆæ¨™æº–ï¼‰

---

# 3. Map ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPC / Mobile å…±é€šï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Filters bar (PC: ä¸Šéƒ¨å›ºå®š / Mobile: ä¸‹éƒ¨å›ºå®š) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MAP (Leaflet canvas)                           â”‚
â”‚   ãƒ”ãƒ³ / ã‚¯ãƒ©ã‚¹ã‚¿ / Popup                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é«˜ã•ï¼š**

* PC â†’ `calc(100vh - FiltersBarHeight)`
* Mobile â†’ `calc(100vh - BottomTabs)`

ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒ Map ã«å¹²æ¸‰ã—ãªã„ã‚ˆã†ã€
**Mobile ã¯ 2æœ¬æŒ‡ + ãƒœã‚¿ãƒ³ã‚ºãƒ¼ãƒ å¿…é ˆ**ã€‚

---

# 4. åˆæœŸä½ç½®ãƒ»ã‚ºãƒ¼ãƒ 

### PC

```
lat: 35.68
lng: 139.76
zoom: 11
```

### Mobile

```
lat: 35.68
lng: 139.76
zoom: 10
```

---

# 5. ãƒ”ãƒ³ï¼ˆMarkerï¼‰ä»•æ§˜ â€” èªè¨¼4æ®µéšè‰²

| status     | è‰²å    | Hex       | ã‚µã‚¤ã‚º  |
| ---------- | ----- | --------- | ---- |
| owner      | Amber | `#F59E0B` | 28px |
| community  | Blue  | `#3B82F6` | 26px |
| directory  | Teal  | `#14B8A6` | 24px |
| unverified | Gray  | `#9CA3AF` | 22px |

**å½¢çŠ¶ï¼š**

* ä¸¸å‹ drop-pinï¼ˆSVGï¼‰
* ç™½æ  2px
* ä¸­å¤®ã«ç™½ã„ dot

**Hover ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼š**

```
scale: 1 â†’ 1.12
duration: 0.15s
```

---

# 6. ã‚¯ãƒ©ã‚¹ã‚¿ï¼ˆMarkerClusterï¼‰

### è‰²

| ä»¶æ•°     | è‰²                   |
| ------ | ------------------- |
| 2â€“9    | `#93C5FD`ï¼ˆBlue-300ï¼‰ |
| 10â€“49  | `#60A5FA`ï¼ˆBlue-400ï¼‰ |
| 50â€“199 | `#3B82F6`ï¼ˆBlue-500ï¼‰ |
| 200+   | `#1D4ED8`ï¼ˆBlue-700ï¼‰ |

### ãƒ©ãƒ™ãƒ«

```
font-size: 13px
font-weight: 600
color: #FFFFFF
```

---

# 7. Popupï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ â€” Map å´ã®å½¹å‰²

Popup ã® UI è‡ªä½“ã¯
**ui-popup-v3.2.md** ãŒæœ¬ä½“ã ãŒã€
Map å´ã®å‹•ä½œã¯ã“ã“ã§å®šç¾©ã™ã‚‹ã€‚

## 7.1 Popup ç™ºç«æ¡ä»¶

```
marker.mouseover â†’ show popupï¼ˆPCï¼‰
marker.click â†’ show popupï¼ˆMobileï¼‰
```

## 7.2 Popup â†’ Drawer é€£æº

```
ã€ŒView detailsã€ã‚¯ãƒªãƒƒã‚¯ â†’ Drawer open with id
```

---

# 8. Drawer é€£æºï¼ˆMap å´ï¼‰

```
drawer.open(id) â†’ 
    1. map.panTo(markerä½ç½®)
    2. popup.close()
    3. marker.scale upï¼ˆé¸æŠçŠ¶æ…‹ï¼‰
```

---

# 9. ãƒ•ã‚£ãƒ«ã‚¿é€£å‹•ï¼ˆMap å´ã®è²¬å‹™ï¼‰

ãƒ•ã‚£ãƒ«ã‚¿ã¯ FiltersBar ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ãŒã€
**Map ã¯æ¬¡ã®è²¬å‹™ã‚’æŒã¤ï¼š**

### 9.1 ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚

```
1. /api/places?xxx ã‚’å†ãƒ•ã‚§ãƒƒãƒ
2. æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’ remove
3. æ–°è¦ãƒãƒ¼ã‚«ãƒ¼ã‚’ add
4. ã‚¯ãƒ©ã‚¹ã‚¿å†ç”Ÿæˆ
```

### 9.2 ã‚¯ã‚¨ãƒªåŒæœŸ

```
/map?category=cafe&chain=BTC&verification=owner
```

Map åˆæœŸåŒ–æ™‚ã¯å¿…ãš
**URL â†’ State â†’ API** ã®é †ã«åŒæœŸã€‚

---

# 10. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆå¿…é ˆï¼‰

* ãƒãƒ¼ã‚«ãƒ¼ã¯ `L.layerGroup()` ã§ãƒãƒƒãƒå‡¦ç†
* ç”»åƒèª­ã¿è¾¼ã¿ã¯ã—ãªã„ï¼ˆPopup ã§ã‚‚ã‚µãƒ ãƒãªã—ï¼‰
* PostGIS ã¯ãƒ•ãƒ­ãƒ³ãƒˆã«ã¯è¿”ã•ãªã„ï¼ˆlat/lngã®ã¿ï¼‰
* Map åˆæœŸåŒ–ã¯ä¸€åº¦ã ã‘ã€‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç¦æ­¢

---

# 11. PC / Mobile ã®æŒ™å‹•åˆ†å²

### PC

* hover ã§ popup
* click ã§ drawer
* Zoom with scroll

### Mobile

* hover ç¦æ­¢ï¼ˆclick onlyï¼‰
* scroll zoom â†’ 2æœ¬æŒ‡é™å®š
* Popup ã®è¡¨ç¤ºã¯ãƒ¯ãƒ³ã‚¿ãƒƒãƒ
* Drawer ã¯ bottom-sheet å…¨ç”»é¢

---

# 12. Map ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹é€ 

```
app/map/page.tsx
components/map/LeafletMap.tsx
components/map/useMap.ts
components/map/markers.ts
components/map/clusters.ts
components/map/events.ts
components/map/drawer-sync.ts
```

**Map UI ã¯ 1 ç”»é¢ 1 Map ã®åŸå‰‡ã€‚**

---

# 13. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

API ã‚¨ãƒ©ãƒ¼æ™‚ï¼š

```
toast.error("Failed to load places")
```

Map è¡¨ç¤ºã¯ç¶­æŒã€ãƒãƒ¼ã‚«ãƒ¼ãªã—çŠ¶æ…‹ã®ã¾ã¾ã€‚

---

# 14. å®Œæˆæ¡ä»¶ï¼ˆChecklistï¼‰

| é …ç›®             | æ¡ä»¶                        |
| -------------- | ------------------------- |
| ãƒ”ãƒ³è‰²4æ®µéš         | æ­£ã—ãè‰² / ã‚µã‚¤ã‚º / SVG åæ˜        |
| Popup â†’ Drawer | 100% æ­£ã—ãé€£æº                |
| ãƒ•ã‚£ãƒ«ã‚¿           | å…¨éƒ¨åæ˜ ã€ã‚¯ãƒ©ã‚¹ã‚¿å†ç”Ÿæˆ              |
| PC/Mobile      | å®Œå…¨æŒ™å‹•åˆ†é›¢                    |
| URL åŒæœŸ         | DeepLink fully functional |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹        | 2000ä»¶è¶…ã§ã‚‚ 60fps            |

---
